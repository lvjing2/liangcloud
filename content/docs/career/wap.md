---
weight: 999
title: "WAP两年工作的小结"
description: ""
icon: "article"
date: "2024-01-09T11:04:47+08:00"
lastmod: "2024-01-09T11:04:47+08:00"
draft: true
toc: true
---


毕业之后已经工作两年了，培训了半年，真正在组里工作的时间也有一年半了。这一年半里，学习了一些东西，思考了一些问题，也做出了一些事情，组里负责的产品基本上已经完善的差不多了，这里总结一下，也算是对自己这一阶段的一个交代吧。

WAP是一家ERP企业管理软件公司，提供ERP软件的研发，销售，维护等一整套的服务。而当今时代由于WEB功能的逐渐强大,WEB应用部署维护成本低跨平台，具有统一便捷的操作方式等优点，ERP软件的发展也已经由原来的C/S正转变为B/S模式，成为部署在云端的SAAS应用。然而ERP应用软件与一般的B/S应用有两个比较大的不同点：页面结构比较复杂，数据量也比较大。所以如果不进行一定的设计优化，那么随着业务的发展，应用的性能会越来越差。所以在开发设计之初就针对这两个问题提出了对应的解决方案。

### 自建后端渲染引擎-forneus，解决页面结构复杂，渲染时间长的问题
我组基于thymeleaf自建了一套后台渲染引擎，这个渲染引擎有四个特点：
1. 组件化，在这个功能的基础上我司有专门负责公用组件开发的队伍，那么开发人员开发页面时只需要调用组件，可以大幅提高开发人员的生产效率。同时由于组件化，所以公司开发的产品的样式会非常统一。
2. 组件解析生成骨架文件以及数据绑定文件便于缓存，这个可以让用户在访问页面时避免重复解析xml文件，那么用户访问页面时就只需要进行数据的绑定即可。
3. 基于Stack结构的数据绑定，能较大幅度提高页面的数据绑定，这个是在runtime时解决页面结构复杂，渲染时间长的一大利器。
4. 页面元数据的可配置性，因为当开发人员完成了应用的开发并发布给了客户，但是不同客户对同一页面可能需要有一些需要自定义的样式，这些可自定义的样式通过配置数据库里的元数据，forneus在生成页面时根据这些元数据生成满足不同客户需求的页面。


首先对于后端渲染引擎的组件化其实是比较难实现的，所以就我已知的开源后端渲染引擎都是不支持这一特性的。那么forneus是如何实现组件化的呢？首先根据组件的特点可以分为容器组件和傻瓜组件（可以理解为dom树里的非叶子组件和叶子组件）,对于每个组件，我们需要定义四个对应的文件：
1. 定义组件具体tag的xml文件,其中会有组件的嵌套使用等
2. 定义该组件的属性，以及元数据信息的java文件,该文件也是后端渲染引擎解析时的入口文件
3. 组件行为相关的js文件
4. 组件样式相关的less文件

那么forneus的主要工作内容就是将页面使用到的各个组件的xml文件,js文件,less文件解析成最终的一个完整的html文件以及对应的js文件和css文件。当然也有它的劣势，那就是学习曲线非常陡峭，另外部分需要client rendering的都必须通过发送请求到后端由后端渲染生成一段html返回给前端。

图1


对于上图的解析过程，我们发现可以将一些跟用户数据无关的过程产生的文件进行预热缓存，即上图的stack骨架文件，js文件和css文件。这样的话，当我们部署好系统之后用户访问页面，用户发送一个请求所需的TTLB（time to last byte）时间就等于business逻辑处理时间+获取缓存文件时间+数据绑定时间,从而避免了非常耗时的组件解析过程。那么这个预热缓存就是后面会介绍的内容。

基于这样的情况，我们设计了一套用于对这些文件进行预热缓存的项目。这个项目随着不断公司业务的不断发展，已经进行了4次的迭代和演化。

### 页面元数据的缓存，减少页面生成时需要获取的数据量，从而进一步提高页面生成速率

页面的元数据是指生成或者访问页面所需要的配置数据，例如菜单数据，IP限制数据，url权限数据等不会随着用户业务的变化而变化的数据。对于这部分数据，是无法将这些数据解析并生成在页面骨架文件中的，且每一次处理页面请求是都需要去获取一次，如果每次都需要从数据库获取这类数据，就会使页面访问速度大幅下降，所以我们设计了一套元数据的缓存系统。即在运行时当用户第一次获取这些数据时会从数据库中读取同时写入到server的本地文件中，那么当用户第二次需要这些数据时就可以直接从文件缓存中获取了，这样页面只是在第一次被访问时会慢一些而已，后续的都会比较快。

该设计中的问题：

优化后的设计：













现阶段正考虑讲所有的产品全部迁移成serverless服务。
